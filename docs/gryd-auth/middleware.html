<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middleware - GrydAuthentication Framework</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-6 py-8">
        <div class="bg-white rounded-lg shadow-md p-8">
            <div class="flex items-center mb-6">
                <a href="index.html" class="text-green-600 hover:text-green-800 mr-4">‚Üê Voltar</a>
                <h1 class="text-3xl font-bold text-gray-800">üîÑ Middleware</h1>
            </div>

            <div class="prose max-w-none">
                <h2>Middleware Implementados no GrydAuthentication Framework</h2>
                <p>Documenta√ß√£o dos middlewares realmente implementados no c√≥digo fonte.</p>

                <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500 my-6">
                    <h3 class="text-yellow-800 font-semibold">‚ö†Ô∏è Middlewares Dispon√≠veis</h3>
                    <p class="text-yellow-700">O framework possui apenas 2 middlewares customizados implementados:</p>
                    <ul class="text-sm text-yellow-700 mt-2">
                        <li>‚Ä¢ <strong>ExceptionHandlingMiddleware</strong> - Tratamento global de exce√ß√µes</li>
                        <li>‚Ä¢ <strong>AppIdAuthorizationMiddleware</strong> - Valida√ß√£o de AppId por usu√°rio</li>
                    </ul>
                </div>

                <h2>üõ°Ô∏è ExceptionHandlingMiddleware</h2>
                <p>Middleware para tratamento global de exce√ß√µes implementado no framework.</p>

                <h3>Implementa√ß√£o</h3>
                <pre><code class="language-csharp">// ExceptionHandlingMiddleware.cs (implementado)
public class ExceptionHandlingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger&lt;ExceptionHandlingMiddleware&gt; _logger;

    public ExceptionHandlingMiddleware(RequestDelegate next, ILogger&lt;ExceptionHandlingMiddleware&gt; logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        try
        {
            await _next(context);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "An unhandled exception occurred");
            await HandleExceptionAsync(context, ex);
        }
    }

    private static async Task HandleExceptionAsync(HttpContext context, Exception exception)
    {
        context.Response.ContentType = "application/json";
        
        var response = new
        {
            error = "An error occurred while processing your request",
            details = exception.Message
        };

        switch (exception)
        {
            case ArgumentException:
                context.Response.StatusCode = StatusCodes.Status400BadRequest;
                break;
            case UnauthorizedAccessException:
                context.Response.StatusCode = StatusCodes.Status401Unauthorized;
                break;
            case NotImplementedException:
                context.Response.StatusCode = StatusCodes.Status501NotImplemented;
                break;
            default:
                context.Response.StatusCode = StatusCodes.Status500InternalServerError;
                break;
        }

        var jsonResponse = JsonSerializer.Serialize(response);
        await context.Response.WriteAsync(jsonResponse);
    }
}</code></pre>

                <h3>Configura√ß√£o</h3>
                <pre><code class="language-csharp">// Program.cs
app.UseMiddleware&lt;ExceptionHandlingMiddleware&gt;();</code></pre>

                <h2>üè¢ AppIdAuthorizationMiddleware</h2>
                <p>Middleware para validar se o usu√°rio autenticado est√° vinculado ao AppId da requisi√ß√£o.</p>

                <h3>Implementa√ß√£o Real</h3>
                <pre><code class="language-csharp">// AppIdAuthorizationMiddleware.cs (implementado)
/// &lt;summary&gt;
/// Middleware para validar se o usu√°rio autenticado est√° vinculado ao appId da requisi√ß√£o/JWT
/// &lt;/summary&gt;
public class AppIdAuthorizationMiddleware
{
    private readonly RequestDelegate _next;
    private readonly string _appIdHeader = "X-App-Id";

    public AppIdAuthorizationMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context, AuthenticationDbContext dbContext)
    {
        // Extrai appId do header ou claim do JWT
        var appId = context.Request.Headers[_appIdHeader].FirstOrDefault();
        if (string.IsNullOrEmpty(appId))
        {
            appId = context.User.FindFirst("appId")?.Value;
        }

        if (string.IsNullOrEmpty(appId))
        {
            context.Response.StatusCode = StatusCodes.Status403Forbidden;
            await context.Response.WriteAsync("AppId n√£o informado.");
            return;
        }

        // Extrai email do JWT
        var email = context.User.FindFirst(ClaimTypes.Email)?.Value;
        if (string.IsNullOrEmpty(email))
        {
            context.Response.StatusCode = StatusCodes.Status401Unauthorized;
            await context.Response.WriteAsync("Usu√°rio n√£o autenticado.");
            return;
        }

        // Busca usu√°rio local
        var user = await dbContext.Users.Include(u => u.AppIds)
            .FirstOrDefaultAsync(u => u.Email == email);
        
        if (user == null || !user.AppIds.Contains(appId))
        {
            context.Response.StatusCode = StatusCodes.Status403Forbidden;
            await context.Response.WriteAsync("AppId n√£o autorizado para este usu√°rio.");
            return;
        }

        await _next(context);
    }
}</code></pre>

                <h3>Como Funciona</h3>
                <div class="bg-blue-50 p-4 rounded-lg my-4">
                    <h4 class="font-semibold text-blue-800">üîç Fluxo de Valida√ß√£o</h4>
                    <ol class="text-sm text-blue-700 mt-2 space-y-1">
                        <li>1. Extrai AppId do header <code>X-App-Id</code> ou claim JWT</li>
                        <li>2. Verifica se AppId foi informado</li>
                        <li>3. Extrai email do usu√°rio do token JWT</li>
                        <li>4. Busca usu√°rio no banco de dados</li>
                        <li>5. Valida se usu√°rio tem acesso ao AppId</li>
                        <li>6. Permite ou nega a requisi√ß√£o</li>
                    </ol>
                </div>

                <h3>Configura√ß√£o</h3>
                <pre><code class="language-csharp">// Program.cs
app.UseMiddleware&lt;AppIdAuthorizationMiddleware&gt;();</code></pre>

                <h3>Headers da Requisi√ß√£o</h3>
                <pre><code class="language-http">Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
X-App-Id: my-application-id
Content-Type: application/json</code></pre>

                <h2>üîß Pipeline de Middleware</h2>
                <p>Ordem de configura√ß√£o no Program.cs:</p>

                <pre><code class="language-csharp">// Program.cs - Pipeline implementado
var app = builder.Build();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

// Authentication/Authorization (ASP.NET Core built-in)
app.UseAuthentication();
app.UseAuthorization();

// Custom middlewares (implementados)
app.UseMiddleware&lt;ExceptionHandlingMiddleware&gt;();
app.UseMiddleware&lt;AppIdAuthorizationMiddleware&gt;();

app.MapControllers();

app.Run();</code></pre>

                <h2>‚ùå Middlewares N√ÉO Implementados</h2>
                <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                    <h3 class="text-red-800 font-semibold mb-2">Funcionalidades Ausentes</h3>
                    <p class="text-red-700 text-sm mb-2">Os seguintes middlewares n√£o est√£o implementados no framework:</p>
                    <ul class="text-sm text-red-700 space-y-1">
                        <li>‚Ä¢ Rate Limiting Middleware</li>
                        <li>‚Ä¢ Session Management Middleware</li>
                        <li>‚Ä¢ IP Filtering Middleware</li>
                        <li>‚Ä¢ Request Validation Middleware</li>
                        <li>‚Ä¢ Security Headers Middleware</li>
                        <li>‚Ä¢ Audit Logging Middleware</li>
                        <li>‚Ä¢ Response Formatting Middleware</li>
                        <li>‚Ä¢ User Context Middleware</li>
                    </ul>
                </div>

                <h2>üîç Testing</h2>
                <p>O ExceptionHandlingMiddleware possui testes unit√°rios implementados:</p>

                <pre><code class="language-csharp">// ExceptionHandlingMiddlewareTests.cs (implementado)
public class ExceptionHandlingMiddlewareTests
{
    [Fact]
    public async Task InvokeAsync_HandlesExceptionCorrectly()
    {
        // Test implementation available in the codebase
    }
}</code></pre>

                <h2>üéØ Uso Pr√°tico</h2>

                <h3>Exemplo de Requisi√ß√£o com AppId</h3>
                <pre><code class="language-bash">curl -X GET "https://api.yourapp.com/api/users" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "X-App-Id: ecommerce-app" \
  -H "Content-Type: application/json"</code></pre>

                <h3>Respostas de Erro</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">403 - AppId n√£o informado</h4>
                        <pre class="text-xs"><code class="language-json">"AppId n√£o informado."</code></pre>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">403 - AppId n√£o autorizado</h4>
                        <pre class="text-xs"><code class="language-json">"AppId n√£o autorizado para este usu√°rio."</code></pre>
                    </div>
                </div>

                <div class="bg-green-50 p-6 rounded-lg border border-green-200 my-8">
                    <h3 class="font-semibold text-green-800 mb-4">‚úÖ Middlewares Implementados</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-green-700">
                        <div>
                            <h4 class="font-semibold mb-2">üõ°Ô∏è ExceptionHandlingMiddleware:</h4>
                            <ul class="space-y-1">
                                <li>‚Ä¢ Captura exce√ß√µes n√£o tratadas</li>
                                <li>‚Ä¢ Log de erros com Serilog</li>
                                <li>‚Ä¢ Resposta JSON padronizada</li>
                                <li>‚Ä¢ Mapeamento de status codes</li>
                                <li>‚Ä¢ Testes unit√°rios inclu√≠dos</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">üè¢ AppIdAuthorizationMiddleware:</h4>
                            <ul class="space-y-1">
                                <li>‚Ä¢ Valida√ß√£o de AppId por usu√°rio</li>
                                <li>‚Ä¢ Suporte a header e JWT claim</li>
                                <li>‚Ä¢ Integra√ß√£o com Entity Framework</li>
                                <li>‚Ä¢ Valida√ß√£o de usu√°rio autenticado</li>
                                <li>‚Ä¢ Respostas de erro espec√≠ficas</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 my-8">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="font-semibold text-blue-800 mb-2">‚öôÔ∏è Configura√ß√£o</h3>
                        <p class="text-sm text-blue-600 mb-3">Como configurar o framework</p>
                        <a href="configuration.html" class="text-blue-600 text-sm font-medium hover:underline">
                            Ver Configura√ß√£o ‚Üí
                        </a>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h3 class="font-semibold text-purple-800 mb-2">üè† Home</h3>
                        <p class="text-sm text-purple-600 mb-3">Voltar √† documenta√ß√£o principal</p>
                        <a href="index.html" class="text-purple-600 text-sm font-medium hover:underline">
                            Voltar ao In√≠cio ‚Üí
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>hljs.highlightAll();</script>
</body>
</html>
