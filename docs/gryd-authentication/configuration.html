<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√£o - GrydAuthentication Framework</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-6 py-8">
        <div class="bg-white rounded-lg shadow-md p-8">
            <div class="flex items-center mb-6">
                <a href="index.html" class="text-green-600 hover:text-green-800 mr-4">‚Üê Voltar</a>
                <h1 class="text-3xl font-bold text-gray-800">‚öôÔ∏è Configura√ß√£o</h1>
            </div>

            <div class="prose max-w-none">
                <h2>Configura√ß√£o B√°sica do GrydAuthentication Framework</h2>
                <p>Configura√ß√£o baseada no c√≥digo real do framework, incluindo JWT e Auth0.</p>

                <h2>üì¶ Instala√ß√£o</h2>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-2">Via Package Manager Console</h3>
                    <pre><code class="language-bash">Install-Package GrydAuthenticationFramework.Infrastructure
Install-Package GrydAuthenticationFramework.Infrastructure.Auth0</code></pre>
                </div>

                <h2>üöÄ Configura√ß√£o Autom√°tica de DbContext (NOVO)</h2>
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                    <p class="text-blue-800"><strong>‚ö° Novidade:</strong> O framework agora oferece configura√ß√£o autom√°tica dos DbSets para simplificar a integra√ß√£o em novos projetos!</p>
                </div>

                <h3>‚ú® Benef√≠cios da Configura√ß√£o Autom√°tica</h3>
                <ul class="list-disc pl-6 mb-4">
                    <li><strong>Configura√ß√£o Autom√°tica:</strong> DbSets de autentica√ß√£o s√£o configurados automaticamente</li>
                    <li><strong>Redu√ß√£o de C√≥digo:</strong> N√£o √© necess√°rio declarar manualmente cada DbSet</li>
                    <li><strong>Nomes de Tabela Corretos:</strong> As configura√ß√µes do framework s√£o aplicadas automaticamente</li>
                    <li><strong>Facilidade de Manuten√ß√£o:</strong> Atualiza√ß√µes no framework se propagam automaticamente</li>
                </ul>

                <h3>üõ†Ô∏è Op√ß√£o 1: Interface IAuthenticationDbContext (Mais Flex√≠vel)</h3>
                <pre><code class="language-csharp">using GrydAuthenticationFramework.Infrastructure.Common.Interfaces;
using GrydAuthenticationFramework.Infrastructure.Extensions;

public class ApplicationDbContext : BaseDbContext, IAuthenticationDbContext
{
    // DbSets de autentica√ß√£o implementados automaticamente via interface
    public DbSet&lt;User&gt; Users =&gt; Set&lt;User&gt;();
    public DbSet&lt;Role&gt; Roles =&gt; Set&lt;Role&gt;();
    public DbSet&lt;Permission&gt; Permissions =&gt; Set&lt;Permission&gt;();
    public DbSet&lt;UserRole&gt; UserRoles =&gt; Set&lt;UserRole&gt;();
    public DbSet&lt;UserPermission&gt; UserPermissions =&gt; Set&lt;UserPermission&gt;();
    public DbSet&lt;RolePermission&gt; RolePermissions =&gt; Set&lt;RolePermission&gt;();
    public DbSet&lt;RefreshToken&gt; RefreshTokens =&gt; Set&lt;RefreshToken&gt;();

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        
        // Configura√ß√£o autom√°tica das entidades de autentica√ß√£o
        modelBuilder.ConfigureAuthenticationEntities(this);
        
        // Configure suas entidades espec√≠ficas...
    }
}</code></pre>

                <h3>üéØ Op√ß√£o 2: BaseDbContextWithAuthentication (Mais Simples - RECOMENDADO)</h3>
                <pre><code class="language-csharp">using GrydAuthenticationFramework.Infrastructure.Data;

public class ApplicationDbContext : BaseDbContextWithAuthentication
{
    public ApplicationDbContext(DbContextOptions&lt;ApplicationDbContext&gt; options) 
        : base(options)
    {
    }

    // Apenas suas entidades espec√≠ficas
    public DbSet&lt;MyEntity&gt; MyEntities { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // Chama base que j√° configura tudo automaticamente
        base.OnModelCreating(modelBuilder);

        // Configure apenas suas entidades espec√≠ficas
        modelBuilder.ApplyConfiguration(new MyEntityConfiguration());
    }
}</code></pre>

                <h3>‚öôÔ∏è Op√ß√£o 3: Apenas o M√©todo de Extens√£o (M√°xima Flexibilidade)</h3>
                <pre><code class="language-csharp">using GrydAuthenticationFramework.Infrastructure.Extensions;

public class ApplicationDbContext : DbContext
{
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        
        // Aplica apenas as configura√ß√µes do framework
        modelBuilder.ApplyAuthenticationConfigurations();
        
        // Voc√™ ainda precisa declarar os DbSets manualmente
    }
}</code></pre>

                <div class="bg-green-50 border-l-4 border-green-400 p-4 my-6">
                    <p class="text-green-800"><strong>üí° Recomenda√ß√£o:</strong> Use a <strong>Op√ß√£o 2</strong> (BaseDbContextWithAuthentication) para m√°xima simplicidade em novos projetos!</p>
                </div>

                <h2>üîß Program.cs Configuration</h2>
                <p>Configura√ß√£o no Program.cs conforme implementado:</p>

                <pre><code class="language-csharp">using GrydAuthenticationFramework.Application;
using GrydAuthenticationFramework.Infrastructure;
using GrydAuthenticationFramework.Infrastructure.Auth0;
using GrydAuthenticationFramework.API.Middleware;

var builder = WebApplication.CreateBuilder(args);

// Configure Serilog (implementado)
Log.Logger = new LoggerConfiguration()
    .ReadFrom.Configuration(builder.Configuration)
    .Enrich.FromLogContext()
    .WriteTo.Console()
    .WriteTo.File("logs/gryd-auth-.txt", rollingInterval: RollingInterval.Day)
    .CreateLogger();

builder.Host.UseSerilog();

// Add services to the container
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();

// Add Swagger with JWT support (implementado)
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new() { Title = "Gryd Authentication Framework API", Version = "v1" });
    
    // JWT Authentication for Swagger
    c.AddSecurityDefinition("Bearer", new Microsoft.OpenApi.Models.OpenApiSecurityScheme
    {
        Name = "Authorization",
        Type = Microsoft.OpenApi.Models.SecuritySchemeType.ApiKey,
        Scheme = "Bearer",
        BearerFormat = "JWT",
        In = Microsoft.OpenApi.Models.ParameterLocation.Header,
        Description = "Enter JWT Bearer token"
    });
});

// Add Framework services (implementado)
builder.Services.AddApplicationServices();
builder.Services.AddInfrastructureServices(builder.Configuration);
builder.Services.AddAuth0Services(builder.Configuration);

var app = builder.Build();

// Configure the HTTP request pipeline
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

// Authentication/Authorization (implementado)
app.UseAuthentication();
app.UseAuthorization();

// Custom middleware (implementado)
app.UseMiddleware&lt;ExceptionHandlingMiddleware&gt;();
app.UseMiddleware&lt;AppIdAuthorizationMiddleware&gt;();

app.MapControllers();

app.Run();</code></pre>

                <h2>üìã appsettings.json</h2>
                <p>Configura√ß√£o baseada no arquivo real do projeto:</p>

                <pre><code class="language-json">{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=GrydAuthenticationFramework;Trusted_Connection=true;MultipleActiveResultSets=true"
  },
  "JwtSettings": {
    "SecretKey": "YourSuperSecretKeyThatShouldBeAtLeast32CharactersLong",
    "Issuer": "GrydAuthenticationFramework",
    "Audience": "GrydAuthenticationFramework",
    "ExpirationMinutes": 60
  },
  "Auth0": {
    "Domain": "your-auth0-domain.auth0.com",
    "ClientId": "your-auth0-client-id",
    "ClientSecret": "your-auth0-client-secret",
    "Audience": "your-auth0-api-audience",
    "ManagementApiAudience": "https://your-auth0-domain.auth0.com/api/v2/",
    "ConnectionName": "Username-Password-Authentication",
    "SocialProviders": {
      "google": {
        "Name": "Google",
        "ConnectionName": "google-oauth2",
        "Enabled": true
      },
      "facebook": {
        "Name": "Facebook",
        "ConnectionName": "facebook",
        "Enabled": true
      },
      "github": {
        "Name": "GitHub",
        "ConnectionName": "github",
        "Enabled": true
      }
    }
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "Console"
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/gryd-auth-.txt",
          "rollingInterval": "Day",
          "rollOnFileSizeLimit": true,
          "fileSizeLimitBytes": 10485760
        }
      }
    ],
    "Enrich": ["FromLogContext"]
  }
}</code></pre>

                <h2>üóÉÔ∏è Database Configuration</h2>
                <p>Entity Framework Core est√° configurado via AuthenticationDbContext:</p>

                <pre><code class="language-csharp">// AuthenticationDbContext implementado
public class AuthenticationDbContext : DbContext
{
    public DbSet&lt;User&gt; Users { get; set; }
    public DbSet&lt;Role&gt; Roles { get; set; }
    public DbSet&lt;Permission&gt; Permissions { get; set; }
    
    // Configura√ß√£o via InfrastructureServiceRegistration
}</code></pre>

                <h2>üîê JWT Configuration</h2>
                <p>Configura√ß√£o JWT implementada via InfrastructureServiceRegistration:</p>

                <pre><code class="language-csharp">// Configura√ß√£o JWT real do c√≥digo
services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.RequireHttpsMetadata = false; // Set to true in production
    options.SaveToken = true;
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuerSigningKey = true,
        IssuerSigningKey = new SymmetricSecurityKey(key),
        ValidateIssuer = true,
        ValidIssuer = jwtSettings["Issuer"] ?? "GrydAuthenticationFramework",
        ValidateAudience = true,
        ValidAudience = jwtSettings["Audience"] ?? "GrydAuthenticationFramework",
        ValidateLifetime = true,
        ClockSkew = TimeSpan.Zero
    };
});</code></pre>

                <h2>üè¢ AppId Authorization Middleware</h2>
                <p>Middleware implementado para valida√ß√£o de AppId:</p>

                <pre><code class="language-csharp">// AppIdAuthorizationMiddleware implementado
public class AppIdAuthorizationMiddleware
{
    private readonly RequestDelegate _next;
    private readonly string _appIdHeader = "X-App-Id";

    public async Task InvokeAsync(HttpContext context, AuthenticationDbContext dbContext)
    {
        // Extrai appId do header ou claim do JWT
        var appId = context.Request.Headers[_appIdHeader].FirstOrDefault();
        if (string.IsNullOrEmpty(appId))
        {
            appId = context.User.FindFirst("appId")?.Value;
        }

        // Valida se usu√°rio tem acesso ao AppId
        var email = context.User.FindFirst(ClaimTypes.Email)?.Value;
        var user = await dbContext.Users.Include(u => u.AppIds)
            .FirstOrDefaultAsync(u => u.Email == email);
        
        if (user == null || !user.AppIds.Contains(appId))
        {
            context.Response.StatusCode = StatusCodes.Status403Forbidden;
            await context.Response.WriteAsync("AppId n√£o autorizado.");
            return;
        }

        await _next(context);
    }
}</code></pre>

                <h2>üîß Dependency Injection</h2>
                <p>Services implementados no framework:</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-2">Application Services</h3>
                        <ul class="text-sm text-blue-700">
                            <li>‚Ä¢ IAuthenticationService</li>
                            <li>‚Ä¢ IJwtTokenService</li>
                            <li>‚Ä¢ ICurrentUserService</li>
                            <li>‚Ä¢ IPasswordHasher</li>
                            <li>‚Ä¢ IEmailService</li>
                        </ul>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-800 mb-2">Infrastructure Services</h3>
                        <ul class="text-sm text-green-700">
                            <li>‚Ä¢ UserRepository</li>
                            <li>‚Ä¢ RoleRepository</li>
                            <li>‚Ä¢ PermissionRepository</li>
                            <li>‚Ä¢ AuthenticationDbContext</li>
                            <li>‚Ä¢ Auth0Service</li>
                        </ul>
                    </div>
                </div>

                <h2>üìù CQRS Commands/Queries</h2>
                <p>Implementado via MediatR:</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-yellow-800 mb-2">Authentication Commands</h3>
                        <ul class="text-sm text-yellow-700">
                            <li>‚Ä¢ LoginCommand</li>
                            <li>‚Ä¢ SocialLoginCommand</li>
                            <li>‚Ä¢ RefreshTokenCommand</li>
                            <li>‚Ä¢ LogoutCommand</li>
                        </ul>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-purple-800 mb-2">User/Role Queries</h3>
                        <ul class="text-sm text-purple-700">
                            <li>‚Ä¢ GetUsersQuery</li>
                            <li>‚Ä¢ GetUserByIdQuery</li>
                            <li>‚Ä¢ GetAllRolesQuery</li>
                            <li>‚Ä¢ GetRoleByNameQuery</li>
                        </ul>
                    </div>
                </div>

                <h2>üîç Features N√£o Implementadas</h2>
                <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                    <h3 class="text-red-800 font-semibold mb-2">‚ùå Funcionalidades Ausentes</h3>
                    <ul class="text-sm text-red-700 space-y-1">
                        <li>‚Ä¢ Session Management</li>
                        <li>‚Ä¢ Two-Factor Authentication (2FA)</li>
                        <li>‚Ä¢ Password Reset Flow</li>
                        <li>‚Ä¢ Account Lockout</li>
                        <li>‚Ä¢ Rate Limiting</li>
                        <li>‚Ä¢ Redis Caching</li>
                        <li>‚Ä¢ Email Templates</li>
                        <li>‚Ä¢ Audit Logging</li>
                    </ul>
                </div>

                <div class="bg-green-50 p-6 rounded-lg border border-green-200 my-8">
                    <h3 class="font-semibold text-green-800 mb-4">‚úÖ Configura√ß√£o M√≠nima Funcional</h3>
                    <p class="text-sm text-green-700 mb-4">O framework requer apenas estas configura√ß√µes essenciais:</p>
                    <ul class="text-sm text-green-700 space-y-1">
                        <li>‚Ä¢ Connection String para Entity Framework</li>
                        <li>‚Ä¢ JWT Settings (SecretKey, Issuer, Audience)</li>
                        <li>‚Ä¢ Auth0 Settings (Domain, ClientId, ClientSecret)</li>
                        <li>‚Ä¢ Registro dos services via DI</li>
                        <li>‚Ä¢ Middleware pipeline b√°sico</li>
                    </ul>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 my-8">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="font-semibold text-blue-800 mb-2">üéÆ Controllers</h3>
                        <p class="text-sm text-blue-600 mb-3">Documenta√ß√£o real dos endpoints</p>
                        <a href="controllers.html" class="text-blue-600 text-sm font-medium hover:underline">
                            Ver Controllers ‚Üí
                        </a>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h3 class="font-semibold text-purple-800 mb-2">üè† Home</h3>
                        <p class="text-sm text-purple-600 mb-3">Voltar √† documenta√ß√£o principal</p>
                        <a href="index.html" class="text-purple-600 text-sm font-medium hover:underline">
                            Voltar ao In√≠cio ‚Üí
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>hljs.highlightAll();</script>
</body>
</html>
